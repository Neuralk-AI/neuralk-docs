<!-- DO NOT EDIT. -->
<!-- THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY. -->
<!-- TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE: -->
<!-- "auto_examples/0020_selecting_sampling_context.py" -->
<!-- LINE NUMBERS ARE GIVEN BELOW. -->

<a id="sphx-glr-auto-examples-0020-selecting-sampling-context-py"></a>

<a id="example-classification-advanced"></a>

# Controlling the sampling of the Classifier’s context

This script demonstrates how to use sampling context methods with NICL for
classification.

#### NOTE
This illustrates an advanced use case. For a simpler classification example
that does not demonstrate manual control of the sampled context, see
[this example](0010_housing_classification.md#example-housing-classification).

## Sampling Context Methods

When working with very large datasets, inference can become computationally
expensive and time-consuming. To manage this, it is often advised to apply row
sampling, selecting a representative subset of the data to provide as context
while preserving its generalisation capability. In our example, we illustrate
this using random sampling. As with other preprocessing steps, it is
recommended to experiment with different sampling strategies and proportions to
determine what best fits the data characteristics and available computational
resources.

#### WARNING
For this example to run, the environment variables `NEURALK_USERNAME` and
`NEURALK_PASSWORD` must be defined. They will be used to connect to the
Neuralk API.

<!-- GENERATED FROM PYTHON SOURCE LINES 36-37 -->

We start by generating an example dataset

<!-- GENERATED FROM PYTHON SOURCE LINES 39-48 -->
```Python
from sklearn.datasets import make_classification
from sklearn.model_selection import train_test_split

X, y = make_classification(
    n_samples=1_000_000, n_features=10, n_informative=8, n_classes=3, random_state=42
)
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=10_000)
print(f"{X_train.shape=} {y_train.shape=} {X_test.shape=} {y_test.shape=}")
```

```none
X_train.shape=(990000, 10) y_train.shape=(990000,) X_test.shape=(10000, 10) y_test.shape=(10000,)
```

<!-- GENERATED FROM PYTHON SOURCE LINES 49-60 -->

As the dataset is quite large, it is not feasible to feed the whole training
set as context to the Neuralk model when making a prediction. Therefore, if
we send the whole dataset, a portion of it will be sampled.

Often, we have information on which rows are more interesting to keep in the
context. For example, there may be sensible groupings of our data (by date,
geographical location, or other criteria, …) and we may want to keep
examples that are similar to the ones for which we need a prediction, or to
ensure some diversity across those groups.

Here to keep the example simple, we just sample the context randomly.

<!-- GENERATED FROM PYTHON SOURCE LINES 62-71 -->
```Python
import numpy as np

rng = np.random.default_rng()
sample_indices = rng.choice(np.arange(X_train.shape[0]), size=10_000, replace=False)

sampled_X_train, sampled_y_train = X_train[sample_indices], y_train[sample_indices]

print(f"Sampling ratio: {sampled_X_train.shape[0] / X_train.shape[0]:.2%}")
```

```none
Sampling ratio: 1.01%
```

<!-- GENERATED FROM PYTHON SOURCE LINES 72-73 -->

Now we fit the classifier.

<!-- GENERATED FROM PYTHON SOURCE LINES 75-82 -->
```Python
from neuralk import Classifier

classifier = Classifier()

# Fit classifier (nothing happens here as we are using a pre-trained model).
classifier.fit(sampled_X_train, sampled_y_train)
```

<div class="output_subarea output_html rendered_html output_result">
<style>#sk-container-id-1 {
  /\* Definition of color scheme common for light and dark mode \*/
  --sklearn-color-text: #000;
  --sklearn-color-text-muted: #666;
  --sklearn-color-line: gray;
  /\* Definition of color scheme for unfitted estimators \*/
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /\* Definition of color scheme for fitted estimators \*/
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /\* Specific color for light theme \*/
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /\* Redefinition of color scheme for dark theme \*/
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-1 {
  color: var(--sklearn-color-text);
}

#sk-container-id-1 pre {
  padding: 0;
}

#sk-container-id-1 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-1 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-1 div.sk-container {
  /\* jupyter's \`normalize.less\` sets \`[hidden] { display: none; }\`
     but bootstrap.min.css set \`[hidden] { display: none !important; }\`
     so we also need the \`!important\` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 \*/
  display: inline-block !important;
  position: relative;
}

#sk-container-id-1 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /\* draw centered vertical line to link estimators \*/
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/\* Parallel-specific style estimator block \*/

#sk-container-id-1 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-1 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-1 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-1 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:only-child::after {
  width: 0;
}

/\* Serial-specific style estimator block \*/

#sk-container-id-1 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/\* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the \`sk-estimator\` class
\*/

/\* Pipeline and ColumnTransformer style (default) \*/

#sk-container-id-1 div.sk-toggleable {
  /\* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer \*/
  background-color: var(--sklearn-color-background);
}

/\* Toggleable label \*/
#sk-container-id-1 label.sk-toggleable_\_label {
  cursor: pointer;
  display: flex;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
  align-items: start;
  justify-content: space-between;
  gap: 0.5em;
}

#sk-container-id-1 label.sk-toggleable_\_label .caption {
  font-size: 0.6rem;
  font-weight: lighter;
  color: var(--sklearn-color-text-muted);
}

#sk-container-id-1 label.sk-toggleable_\_label-arrow:before {
  /\* Arrow on the left of the label \*/
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-1 label.sk-toggleable_\_label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/\* Toggleable content - dropdown \*/

#sk-container-id-1 div.sk-toggleable_\_content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /\* unfitted \*/
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable_\_content.fitted {
  /\* fitted \*/
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 div.sk-toggleable_\_content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /\* unfitted \*/
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable_\_content.fitted pre {
  /\* unfitted \*/
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 input.sk-toggleable_\_control:checked~div.sk-toggleable_\_content {
  /\* Expand drop-down \*/
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-1 input.sk-toggleable_\_control:checked~label.sk-toggleable_\_label-arrow:before {
  content: "▾";
}

/\* Pipeline/ColumnTransformer-specific style \*/

#sk-container-id-1 div.sk-label input.sk-toggleable_\_control:checked~label.sk-toggleable_\_label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-label.fitted input.sk-toggleable_\_control:checked~label.sk-toggleable_\_label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/\* Estimator-specific style \*/

/\* Colorize estimator box \*/
#sk-container-id-1 div.sk-estimator input.sk-toggleable_\_control:checked~label.sk-toggleable_\_label {
  /\* unfitted \*/
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted input.sk-toggleable_\_control:checked~label.sk-toggleable_\_label {
  /\* fitted \*/
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-1 div.sk-label label.sk-toggleable_\_label,
#sk-container-id-1 div.sk-label label {
  /\* The background is the default theme color \*/
  color: var(--sklearn-color-text-on-default-background);
}

/\* On hover, darken the color of the background \*/
#sk-container-id-1 div.sk-label:hover label.sk-toggleable_\_label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/\* Label box, darken color on hover, fitted \*/
#sk-container-id-1 div.sk-label.fitted:hover label.sk-toggleable_\_label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/\* Estimator label \*/

#sk-container-id-1 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-1 div.sk-label-container {
  text-align: center;
}

/\* Estimator-specific \*/
#sk-container-id-1 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /\* unfitted \*/
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-estimator.fitted {
  /\* fitted \*/
  background-color: var(--sklearn-color-fitted-level-0);
}

/\* on hover \*/
#sk-container-id-1 div.sk-estimator:hover {
  /\* unfitted \*/
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted:hover {
  /\* fitted \*/
  background-color: var(--sklearn-color-fitted-level-2);
}

/\* Specification for estimator info (e.g. "i" and "?") \*/

/\* Common style for "i" and "?" \*/

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 0.5em;
  text-align: center;
  /\* unfitted \*/
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /\* fitted \*/
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/\* On hover \*/
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /\* unfitted \*/
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /\* fitted \*/
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/\* Span, style for the box shown on hovering the info icon \*/
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /\* unfitted \*/
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /\* fitted \*/
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/\* "?"-specific style due to the \`<a>\` HTML tag \*/

#sk-container-id-1 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /\* unfitted \*/
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-1 a.estimator_doc_link.fitted {
  /\* fitted \*/
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/\* On hover \*/
#sk-container-id-1 a.estimator_doc_link:hover {
  /\* unfitted \*/
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-1 a.estimator_doc_link.fitted:hover {
  /\* fitted \*/
  background-color: var(--sklearn-color-fitted-level-3);
}
</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Classifier()</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable_\_control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" checked><label for="sk-estimator-id-1" class="sk-toggleable_\_label fitted sk-toggleable_\_label-arrow"><div><div>Classifier</div></div><div><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></div></label><div class="sk-toggleable_\_content fitted"><pre>Classifier()</pre></div> </div></div></div></div>
</div>
<br />
<br />
<!-- GENERATED FROM PYTHON SOURCE LINES 83-84 -->

And we can make predictions for the test set.

<!-- GENERATED FROM PYTHON SOURCE LINES 86-88 -->
```Python
predictions = classifier.predict(X_test)
```

<!-- GENERATED FROM PYTHON SOURCE LINES 89-90 -->

Finally, we measure the accuracy.

<!-- GENERATED FROM PYTHON SOURCE LINES 92-96 -->
```Python
from sklearn.metrics import accuracy_score

acc = accuracy_score(y_test, predictions)
print(f"Accuracy: {acc:.3f}")
```

```none
Accuracy: 0.947
```

**Total running time of the script:** (0 minutes 38.403 seconds)

<a id="sphx-glr-download-auto-examples-0020-selecting-sampling-context-py"></a>
